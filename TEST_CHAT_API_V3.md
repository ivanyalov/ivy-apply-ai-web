# Chat API v3 Integration Test Plan

## Цель тестирования

Проверить работу новой интеграции Chat API v3 в ChatPage и убедиться, что:

1. Сообщения отправляются через новые endpoints
2. Conversation context сохраняется между сообщениями
3. Follow-up вопросы работают корректно
4. Мультимодальные сообщения (текст + файлы) обрабатываются правильно

## Изменения в системе

### 1. ChatPage.tsx

- ✅ Добавлен импорт `createChatAndPoll`
- ✅ Заменен старый API `/api/chat/message` на Chat API v3
- ✅ Убрана логика `getConversationHistory` (больше не нужна)
- ✅ Добавлено логирование для отладки

### 2. Frontend API

- ✅ Обновлен `createChatAndPoll` для поддержки мультимодальных сообщений
- ✅ Правильная типизация для `string | any[]`

### 3. Backend

- ✅ Новые endpoints созданы и интегрированы
- ✅ Безопасность и валидация настроены

## Тестовые сценарии

### Тест 1: Простое текстовое сообщение

1. Зайти на `/chat`
2. Отправить "Привет!"
3. **Ожидаемый результат:**
   - В консоли: "Sending message using Chat API v3..."
   - Получен ответ от AI
   - В консоли: "Chat API v3 response: { chatId: ..., status: ..., message: ... }"

### Тест 2: Follow-up вопросы

1. Отправить "Помоги выбрать университет"
2. **Ожидаемый результат:**
   - Получен развернутый ответ
   - Отображаются кнопки с дополнительными вопросами
   - При клике на кнопку - отправляется новое сообщение

### Тест 3: Контекст conversation

1. Отправить "Меня зовут Алекс"
2. Отправить "Как меня зовут?"
3. **Ожидаемый результат:**
   - AI помнит имя из предыдущего сообщения
   - Отвечает "Вас зовут Алекс"

### Тест 4: Загрузка файла

1. Загрузить текстовый файл или изображение
2. Добавить текст "Проанализируй этот файл"
3. **Ожидаемый результат:**
   - Файл отображается в сообщении пользователя
   - AI анализирует содержимое файла

### Тест 5: Очистка чата

1. Отправить несколько сообщений
2. Нажать кнопку очистки чата
3. **Ожидаемый результат:**
   - Создается новый conversation
   - История очищается
   - AI не помнит предыдущий контекст

## Проверка в консоли браузера

Ожидаемые логи:

```
Starting conversation initialization...
Loaded existing conversation: conv_123456789
Sending message using Chat API v3...
Chat API v3 response: {
  chatId: "chat_987654321",
  status: "completed",
  message: "Привет! Как дела?..."
}
```

## Проверка в Network tab

Новые запросы:

- `GET /api/conversation/get` - получение conversation
- `POST /api/conversation/create` - создание conversation (только при первом заходе)
- `POST /api/conversation/chat/create-and-poll` - отправка сообщений

Старые запросы (должны исчезнуть):

- ~~`POST /api/chat/message`~~ - больше не используется

## Мониторинг производительности

Сравнить с предыдущей версией:

- Время ответа AI
- Качество контекста
- Стабильность соединения

## Потенциальные проблемы

1. **Типизация мультимодальных сообщений**

   - Убедиться что `ObjectStringItem[]` правильно передается

2. **Сохранение контекста**

   - Проверить что conversation ID правильно передается

3. **Ошибки аутентификации**

   - Убедиться что токены правильно используются

4. **File uploads**
   - Проверить что file_id правильно привязывается к сообщениям

## Успешное тестирование

Тест считается успешным если:

- ✅ Все сообщения отправляются через Chat API v3
- ✅ Conversation context сохраняется между сообщениями
- ✅ Follow-up questions работают
- ✅ Файлы корректно обрабатываются
- ✅ Производительность не хуже предыдущей версии
- ✅ Нет ошибок в консоли браузера или сервера

## Rollback план

Если что-то не работает:

1. Вернуть старый `handleSendMessage` в ChatPage
2. Убрать импорт `createChatAndPoll`
3. Вернуть использование `/api/chat/message`
4. Восстановить `getConversationHistory` логику
