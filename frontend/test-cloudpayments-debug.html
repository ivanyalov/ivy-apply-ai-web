<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>CloudPayments Debug</title>
		<script src="https://widget.cloudpayments.ru/bundles/cloudpayments.js"></script>
		<style>
			body {
				font-family: Arial, sans-serif;
				max-width: 800px;
				margin: 0 auto;
				padding: 20px;
				background-color: #f5f5f5;
			}
			.container {
				background: white;
				padding: 30px;
				border-radius: 10px;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			}
			.button {
				background: #dc143c;
				color: white;
				border: none;
				padding: 15px 30px;
				border-radius: 5px;
				font-size: 18px;
				cursor: pointer;
				margin: 10px 0;
			}
			.button:hover {
				background: #b22222;
			}
			.button:disabled {
				background: #ccc;
				cursor: not-allowed;
			}
			.log {
				background: #f8f9fa;
				border: 1px solid #dee2e6;
				border-radius: 5px;
				padding: 15px;
				margin: 20px 0;
				max-height: 400px;
				overflow-y: auto;
				font-family: monospace;
				font-size: 14px;
			}
			.log-entry {
				margin: 5px 0;
				padding: 5px;
				border-radius: 3px;
			}
			.log-success {
				background: #d4edda;
				color: #155724;
			}
			.log-error {
				background: #f8d7da;
				color: #721c24;
			}
			.log-info {
				background: #d1ecf1;
				color: #0c5460;
			}
			.log-warning {
				background: #fff3cd;
				color: #856404;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>üß™ CloudPayments Debug Page</h1>
			<p>
				–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å CloudPayments —Å–æ–≥–ª–∞—Å–Ω–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
			</p>

			<div>
				<h3>–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:</h3>
				<p>
					<strong>Public ID:</strong>
					<input
						type="text"
						id="publicIdInput"
						value="pk_8d8840db0c2cc65ebdc7ae1ff320b"
						style="width: 300px; padding: 5px; border: 1px solid #ccc; border-radius: 3px"
					/>
					<button
						onclick="updatePublicId()"
						style="
							margin-left: 10px;
							padding: 5px 10px;
							background: #007bff;
							color: white;
							border: none;
							border-radius: 3px;
							cursor: pointer;
						"
					>
						–û–±–Ω–æ–≤–∏—Ç—å
					</button>
				</p>
				<p><strong>–°—É–º–º–∞:</strong> 990 RUB</p>
				<p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> –¢–µ—Å—Ç–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞</p>
				<p>
					<strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ —Å Promise –∏ —Å–æ–±—ã—Ç–∏–µ–º
					oncomplete
				</p>
			</div>

			<div>
				<h3>–î–µ–π—Å—Ç–≤–∏—è:</h3>
				<button class="button" onclick="testCloudPayments()">–¢–µ—Å—Ç CloudPayments</button>
				<button class="button" onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
			</div>

			<div>
				<h3>–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π:</h3>
				<div id="log" class="log"></div>
			</div>
		</div>

		<script>
			// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
			function log(message, type = "info") {
				const logDiv = document.getElementById("log");
				const entry = document.createElement("div");
				entry.className = `log-entry log-${type}`;
				entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
				logDiv.appendChild(entry);
				logDiv.scrollTop = logDiv.scrollHeight;
				console.log(`[${type.toUpperCase()}] ${message}`);
			}

			// –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–∞
			function clearLog() {
				document.getElementById("log").innerHTML = "";
			}

			// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Public ID
			function updatePublicId() {
				const input = document.getElementById("publicIdInput");
				log(`üîÑ Public ID –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞: ${input.value}`, "info");
			}

			// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –±—ç–∫—ç–Ω–¥
			async function sendPaymentToBackend(paymentData) {
				log(`üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –±—ç–∫—ç–Ω–¥: ${JSON.stringify(paymentData, null, 2)}`, "info");

				try {
					const response = await fetch("/api/payments/cloudpayments/payment-success", {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
						},
						body: JSON.stringify({
							transactionId: paymentData.transactionId,
							subscriptionId: paymentData.subscriptionId,
							amount: paymentData.amount,
							currency: paymentData.currency,
							status: paymentData.status,
							token: paymentData.token,
							authCode: paymentData.authCode,
							lastFour: paymentData.lastFour,
						}),
					});

					if (response.ok) {
						const result = await response.json();
						log(
							`‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –±—ç–∫—ç–Ω–¥: ${JSON.stringify(result, null, 2)}`,
							"success"
						);
						alert("–ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞! –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –±–∞–∑–µ.");
					} else {
						const error = await response.json();
						log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞ –±—ç–∫—ç–Ω–¥: ${JSON.stringify(error, null, 2)}`, "error");
						alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–∫–∏. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.");
					}
				} catch (error) {
					log(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞ –±—ç–∫—ç–Ω–¥: ${error.message}`, "error");
					alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.");
				}
			}

			// –¢–µ—Å—Ç CloudPayments —Å–æ–≥–ª–∞—Å–Ω–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
			function testCloudPayments() {
				const publicId = document.getElementById("publicIdInput").value;
				log("üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç CloudPayments...", "info");
				log(`üìã –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–π Public ID: ${publicId}`, "info");

				try {
					// –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å CloudPayments
					if (typeof window.cp === "undefined") {
						log("‚ùå CloudPayments –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!", "error");
						return;
					}

					log("‚úÖ CloudPayments –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ", "success");
					log(`üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥—ã: ${Object.keys(window.cp)}`, "info");

					// –°–æ–∑–¥–∞–µ–º –≤–∏–¥–∂–µ—Ç —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
					const payments = new window.cp.CloudPayments({
						yandexPaySupport: false,
						applePaySupport: false,
						googlePaySupport: false,
						masterPassSupport: false,
						tinkoffInstallmentSupport: false,
					});
					log("‚úÖ –í–∏–¥–∂–µ—Ç CloudPayments —Å–æ–∑–¥–∞–Ω", "success");

					// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ oncomplete —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
					payments.oncomplete = (result) => {
						log("üîÑ oncomplete —Å–æ–±—ã—Ç–∏–µ –≤—ã–∑–≤–∞–Ω–æ!", "info");
						log(`üìã –†–µ–∑—É–ª—å—Ç–∞—Ç: ${JSON.stringify(result, null, 2)}`, "info");

						// –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º status –≤–º–µ—Å—Ç–æ success
						if (result && result.status === "success") {
							log("‚úÖ –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω!", "success");

							// –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ –±—ç–∫—ç–Ω–¥
							const paymentData = {
								transactionId:
									result.data?.transactionId ||
									result.transactionId ||
									result.id ||
									`transaction_${Date.now()}`,
								subscriptionId: result.subscriptionId || result.subscription?.id,
								status: "Completed",
								amount: 990,
								currency: "RUB",
								token: result.token,
								authCode: result.authCode,
								lastFour: result.lastFour,
							};

							log(
								`üíæ –ì–æ—Ç–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏: ${JSON.stringify(paymentData, null, 2)}`,
								"info"
							);

							// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –±—ç–∫—ç–Ω–¥
							sendPaymentToBackend(paymentData);
						} else {
							log("‚ùå –ü–ª–∞—Ç–µ–∂ –Ω–µ —É–¥–∞–ª—Å—è", "error");
							log(
								`üìã –ü—Ä–∏—á–∏–Ω–∞: ${result?.message || result?.status || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}`,
								"error"
							);
						}
					};

					// –°–æ–∑–¥–∞–µ–º —á–µ–∫ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
					const receipt = {
						Items: [
							{
								label: "–ü–æ–¥–ø–∏—Å–∫–∞ Ivy Apply AI",
								price: 990.0,
								quantity: 1.0,
								amount: 990.0,
								vat: 20,
								method: 0,
								object: 0,
							},
						],
						taxationSystem: 0,
						email: "test@example.com",
						phone: "",
						isBso: false,
						amounts: {
							electronic: 990.0,
							advancePayment: 0.0,
							credit: 0.0,
							provision: 0.0,
						},
					};

					// –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
					const data = {
						CloudPayments: {
							CustomerReceipt: receipt,
							recurrent: {
								interval: "Month",
								period: 1,
								customerReceipt: receipt,
							},
						},
					};

					log("üí≥ –ó–∞–ø—É—Å–∫–∞–µ–º –ø–ª–∞—Ç–µ–∂ —Å –ø–æ–¥–ø–∏—Å–∫–æ–π...", "info");

					// –í—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥ pay —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
					payments
						.pay("charge", {
							publicId: publicId,
							accountId: "test-user-" + Date.now(),
							description: "–ü–æ–¥–ø–∏—Å–∫–∞ Ivy Apply AI - –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π –¥–æ—Å—Ç—É–ø",
							amount: 990,
							currency: "RUB",
							invoiceId: "subscription-" + Date.now(),
							data: data,
						})
						.then((result) => {
							// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç Promise
							log("‚úÖ Promise resolved!", "success");
							log(`üìã WidgetResult: ${JSON.stringify(result, null, 2)}`, "info");

							// –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å - –∏—Å–ø–æ–ª—å–∑—É–µ–º status –≤–º–µ—Å—Ç–æ success
							if (result && result.status === "success") {
								log("‚úÖ –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω —á–µ—Ä–µ–∑ Promise!", "success");

								const paymentData = {
									transactionId:
										result.data?.transactionId ||
										result.transactionId ||
										result.id ||
										`transaction_${Date.now()}`,
									subscriptionId: result.subscriptionId || result.subscription?.id,
									status: "Completed",
									amount: 990,
									currency: "RUB",
									token: result.token,
									authCode: result.authCode,
									lastFour: result.lastFour,
								};

								sendPaymentToBackend(paymentData);
							}
						})
						.catch((error) => {
							log(`‚ùå Promise rejected: ${error.message}`, "error");
							console.error("CloudPayments payment error:", error);
						});

					log("‚úÖ –í–∏–¥–∂–µ—Ç CloudPayments –∑–∞–ø—É—â–µ–Ω", "success");
				} catch (error) {
					log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: ${error.message}`, "error");
					console.error("CloudPayments test error:", error);
				}
			}

			// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É CloudPayments –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
			window.addEventListener("load", function () {
				log("üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞", "info");

				if (typeof window.cp !== "undefined") {
					log("‚úÖ CloudPayments –¥–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ", "success");
				} else {
					log("‚ùå CloudPayments –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ", "error");
				}
			});

			// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
			setTimeout(function () {
				if (typeof window.cp !== "undefined") {
					log("‚úÖ CloudPayments –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –∑–∞–¥–µ—Ä–∂–∫–∏", "success");
				} else {
					log("‚ùå CloudPayments –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –∑–∞–¥–µ—Ä–∂–∫–∏", "error");
				}
			}, 2000);
		</script>
	</body>
</html>
